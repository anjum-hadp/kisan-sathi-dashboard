<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kisan Sathi - J&K Agriculture Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; padding: 20px; }
        header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        header p { font-size: 1.2em; opacity: 0.9; }
        
        .config-box { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .config-box h3 { margin-bottom: 15px; color: #333; }
        .config-box input { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 8px; }
        .config-box button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; }
        .config-box button:hover { opacity: 0.9; }
        .config-box .help { color: #666; font-size: 0.9em; margin-top: 10px; }
        
        .loading { text-align: center; padding: 40px; color: white; font-size: 1.2em; }
        .error { background: #ffebee; color: #c62828; padding: 20px; border-radius: 10px; margin: 20px 0; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { color: #666; font-size: 0.85em; text-transform: uppercase; margin-bottom: 8px; }
        .stat-card .value { font-size: 2em; font-weight: bold; color: #333; }
        .stat-card.kashmir { border-left: 5px solid #3498db; }
        .stat-card.jammu { border-left: 5px solid #e74c3c; }
        .stat-card.total { border-left: 5px solid #27ae60; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        .tab:hover, .tab.active { background: white; color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .chart-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .chart-card h3 { margin-bottom: 15px; color: #333; font-size: 1.1em; }
        .chart-container { position: relative; height: 300px; }
        
        .table-section { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; }
        .table-section h2 { margin-bottom: 20px; color: #333; }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .controls input, .controls select { padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; flex: 1; min-width: 200px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 8px; text-align: left; font-weight: 600; }
        td { padding: 10px 8px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        .number { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        .project-cell { font-weight: 600; color: #333; }
        .activity-cell { color: #666; font-size: 0.9em; max-width: 200px; white-space: normal; word-wrap: break-word; line-height: 1.4; }
        .kashmir-col { color: #1565c0; font-weight: 600; background-color: #e3f2fd; border-radius: 4px; padding: 8px 6px; }
        .jammu-col { color: #c62828; font-weight: 600; background-color: #ffebee; border-radius: 4px; padding: 8px 6px; }
        .total-col { color: #2e7d32; font-weight: bold; background-color: #e8f5e9; border-radius: 4px; padding: 8px 6px; }
        
        footer { text-align: center; color: white; padding: 20px; opacity: 0.8; }
        
        .refresh-btn { background: #27ae60; color: white; padding: 8px 20px; border: none; border-radius: 20px; cursor: pointer; margin-left: 10px; }
        .last-updated { color: #666; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåæ Kisan Sathi Dashboard</h1>
            <p>Jammu & Kashmir Agricultural Applications - Live Data from Google Sheets</p>
        </header>
        
        <!-- Configuration Panel -->
        <div class="config-box" id="configPanel">
            <h3>üîó Connect to Google Sheets</h3>
            <input type="text" id="sheetId" placeholder="Google Sheet ID (from URL)">
            <input type="text" id="apiKey" placeholder="Google API Key">
            <button onclick="connectToSheets()">Connect & Load Data</button>
            <button class="refresh-btn" onclick="loadData()" style="display:none" id="refreshBtn">üîÑ Refresh Data</button>
            <div class="help">
                üí° <strong>How to get these:</strong><br>
                1. Sheet ID: Copy from your Google Sheet URL (between /d/ and /edit)<br>
                2. API Key: Get from <a href="https://console.cloud.google.com/" target="_blank" style="color:#667eea">Google Cloud Console</a> ‚Üí Enable Sheets API ‚Üí Create Credentials
            </div>
            <div class="last-updated" id="lastUpdated"></div>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="loading" style="display:none">
            <div>‚è≥ Loading data from Google Sheets...</div>
        </div>
        
        <!-- Error State -->
        <div id="errorState" class="error" style="display:none"></div>
        
        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display:none">
            <div class="stats-grid">
                <div class="stat-card kashmir">
                    <h3>üèîÔ∏è Kashmir Division</h3>
                    <div class="value" id="kashmir-apps">0</div>
                    <p>Appl</p>
                    <div style="margin-top: 8px; font-size: 0.9em;"><span id="kashmir-appr">0</span> Appr (<span id="kashmir-rate">0%</span>)</div>
                </div>
                <div class="stat-card jammu">
                    <h3>üåÑ Jammu Division</h3>
                    <div class="value" id="jammu-apps">0</div>
                    <p>Appl</p>
                    <div style="margin-top: 8px; font-size: 0.9em;"><span id="jammu-appr">0</span> Appr (<span id="jammu-rate">0%</span>)</div>
                </div>
                <div class="stat-card total">
                    <h3>üìä Grand Total</h3>
                    <div class="value" id="total-apps">0</div>
                    <p>Appl</p>
                    <div style="margin-top: 8px; font-size: 0.9em;"><span id="total-appr">0</span> Appr (<span id="total-rate">0%</span>)</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('overview')">üìä Overview</div>
                <div class="tab" onclick="showTab('activities')">üìã Activity Details</div>
            </div>
            
            <div id="overview" class="tab-content active">
                <div class="chart-section">
                    <div class="chart-card">
                        <h3>Division-wise Distribution</h3>
                        <div class="chart-container"><canvas id="divisionChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3>Top 10 Projects by Appl</h3>
                        <div class="chart-container"><canvas id="projectChart"></canvas></div>
                    </div>
                </div>
            </div>
            
            <div id="activities" class="tab-content">
                <div class="table-section">
                    <h2>üìã Project-wise Activity Details</h2>
                    <div class="controls">
                        <input type="text" id="searchInput" placeholder="üîç Search project or activity...">
                        <select id="projectFilter"><option value="">üìÅ All Projects</option></select>
                    </div>
                    <div id="activityTableContainer"></div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Data Source: Google Sheets | Auto-updates when sheet changes</p>
        </footer>
    </div>

    <script>
        // Global variables
        let rawData = [];
        let targetsData = [];
        let charts = {};
        
        // Sheet configuration (stored in memory)
        let sheetConfig = {
            sheetId: '',
            apiKey: ''
        };
        
        // Connect to Google Sheets
        async function connectToSheets() {
            sheetConfig.sheetId = document.getElementById('sheetId').value.trim();
            sheetConfig.apiKey = document.getElementById('apiKey').value.trim();
            
            if (!sheetConfig.sheetId || !sheetConfig.apiKey) {
                alert('Please enter both Sheet ID and API Key');
                return;
            }
            
            await loadData();
        }
        
        // Load data from Google Sheets
        async function loadData() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'none';
            
            try {
                // Fetch Raw Data tab
                const rawResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${sheetConfig.sheetId}/values/Raw%20Data?key=${sheetConfig.apiKey}`
                );
                
                if (!rawResponse.ok) {
                    throw new Error(`Raw Data error: ${rawResponse.status} - Make sure tab is named "Raw Data"`);
                }
                
                const rawJson = await rawResponse.json();
                rawData = parseSheetData(rawJson.values);
                
                // Fetch Targets tab
                const targetsResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${sheetConfig.sheetId}/values/Targets?key=${sheetConfig.apiKey}`
                );
                
                if (!targetsResponse.ok) {
                    throw new Error(`Targets error: ${targetsResponse.status} - Make sure tab is named "Targets"`);
                }
                
                const targetsJson = await targetsResponse.json();
                targetsData = parseSheetData(targetsJson.values);
                
                // Show dashboard
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                document.getElementById('refreshBtn').style.display = 'inline-block';
                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
                
                // Initialize dashboard
                calculateTotals();
                initCharts();
                populateFilters();
                renderActivityTable();
                
            } catch (error) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorState').textContent = `‚ùå Error: ${error.message}`;
                console.error(error);
            }
        }
        
        // Parse Google Sheets data
        function parseSheetData(values) {
            if (!values || values.length < 2) return [];
            
            const headers = values[0];
            const data = [];
            
            for (let i = 1; i < values.length; i++) {
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[i][index] || '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        // Get target for activity
        function getTarget(project, activity) {
            const match = targetsData.find(t => 
                project.toLowerCase().includes((t.Project || '').toLowerCase()) &&
                activity.toLowerCase().includes((t.Activity || '').toLowerCase())
            );
            if (match) {
                const target = match.Target || '';
                const unit = match.Unit || '';
                if (target && unit) return target + ' ' + unit;
                if (target) return target;
                if (unit) return unit;
            }
            return '-';
        }
        
        // Calculate totals
        function calculateTotals() {
            let kApps = 0, kAppr = 0, jApps = 0, jAppr = 0;
            
            rawData.forEach(row => {
                kApps += parseInt(row['K-Appl'] || row['Kashmir_Total_Appl'] || 0);
                kAppr += parseInt(row['K-Appr'] || row['Kashmir_Total_Appr'] || 0);
                jApps += parseInt(row['J-Appl'] || row['Jammu_Total_Appl'] || 0);
                jAppr += parseInt(row['J-Appr'] || row['Jammu_Total_Appr'] || 0);
            });
            
            document.getElementById('kashmir-apps').textContent = kApps.toLocaleString();
            document.getElementById('kashmir-appr').textContent = kAppr.toLocaleString();
            document.getElementById('kashmir-rate').textContent = kApps > 0 ? ((kAppr/kApps)*100).toFixed(1) + '%' : '0%';
            
            document.getElementById('jammu-apps').textContent = jApps.toLocaleString();
            document.getElementById('jammu-appr').textContent = jAppr.toLocaleString();
            document.getElementById('jammu-rate').textContent = jApps > 0 ? ((jAppr/jApps)*100).toFixed(1) + '%' : '0%';
            
            document.getElementById('total-apps').textContent = (kApps + jApps).toLocaleString();
            document.getElementById('total-appr').textContent = (kAppr + jAppr).toLocaleString();
            document.getElementById('total-rate').textContent = (kApps + jApps) > 0 ? (((kAppr+jAppr)/(kApps+jApps))*100).toFixed(1) + '%' : '0%';
        }
        
        // Initialize charts
        function initCharts() {
            // Destroy existing charts
            if (charts.division) charts.division.destroy();
            if (charts.project) charts.project.destroy();
            
            // Calculate totals
            let kTotal = 0, jTotal = 0;
            rawData.forEach(row => {
                kTotal += parseInt(row['K-Appl'] || row['Kashmir_Total_Appl'] || 0);
                jTotal += parseInt(row['J-Appl'] || row['Jammu_Total_Appl'] || 0);
            });
            
            // Division chart
            const divCtx = document.getElementById('divisionChart').getContext('2d');
            charts.division = new Chart(divCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Kashmir Division', 'Jammu Division'],
                    datasets: [{
                        data: [kTotal, jTotal],
                        backgroundColor: ['#3498db', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            
            // Project chart
            const projectTotals = {};
            rawData.forEach(row => {
                const proj = row.Project || row.project || '';
                if (proj) {
                    if (!projectTotals[proj]) projectTotals[proj] = 0;
                    projectTotals[proj] += parseInt(row['Total-Appl'] || row['Grand_Total_Appl'] || 
                                                    row['K-Appl'] || row['Kashmir_Total_Appl'] || 0) +
                                          parseInt(row['J-Appl'] || row['Jammu_Total_Appl'] || 0);
                }
            });
            
            const sorted = Object.entries(projectTotals).sort((a,b) => b[1] - a[1]).slice(0, 10);
            
            const projCtx = document.getElementById('projectChart').getContext('2d');
            charts.project = new Chart(projCtx, {
                type: 'bar',
                data: {
                    labels: sorted.map(p => p[0].substring(0, 25) + '...'),
                    datasets: [{
                        label: 'Appl',
                        data: sorted.map(p => p[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // Populate filters
        function populateFilters() {
            const projects = [...new Set(rawData.map(r => r.Project || r.project))].filter(p => p).sort();
            const select = document.getElementById('projectFilter');
            select.innerHTML = '<option value="">üìÅ All Projects</option>';
            projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                select.appendChild(opt);
            });
            
            document.getElementById('searchInput').addEventListener('input', renderActivityTable);
            document.getElementById('projectFilter').addEventListener('change', renderActivityTable);
        }
        
        // Render activity table
        function renderActivityTable() {
            const container = document.getElementById('activityTableContainer');
            const search = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const project = document.getElementById('projectFilter')?.value || '';
            
            let filtered = rawData;
            if (search) {
                filtered = filtered.filter(r => 
                    ((r.Project || r.project || '').toLowerCase().includes(search)) ||
                    ((r.Activity || r.activity || '').toLowerCase().includes(search))
                );
            }
            if (project) {
                filtered = filtered.filter(r => (r.Project || r.project) === project);
            }
            
            let html = '<table><thead><tr>';
            html += '<th>Project</th><th style="width:180px;">Activity</th>';
            html += '<th class="number kashmir-col">üèîÔ∏è K-Appl</th>';
            html += '<th class="number jammu-col">üåÑ J-Appl</th>';
            html += '<th class="number" style="background:linear-gradient(135deg,#ff9800,#f57c00);color:white">üìä Total-Appl</th>';
            html += '<th class="number kashmir-col">üèîÔ∏è K-Appr</th>';
            html += '<th class="number jammu-col">üåÑ J-Appr</th>';
            html += '<th class="number total-col">üìä Total Appr</th>';
            html += '<th class="number" style="background:linear-gradient(135deg,#7b1fa2,#6a1b9a);color:white">üéØ 5-Year Target</th>';
            html += '</tr></thead><tbody>';
            
            filtered.forEach(row => {
                const kA = parseInt(row['K-Appl'] || row['Kashmir_Total_Appl'] || 0);
                const kAp = parseInt(row['K-Appr'] || row['Kashmir_Total_Appr'] || 0);
                const jA = parseInt(row['J-Appl'] || row['Jammu_Total_Appl'] || 0);
                const jAp = parseInt(row['J-Appr'] || row['Jammu_Total_Appr'] || 0);
                const tA = kA + jA;
                const tAp = kAp + jAp;
                const tgt = getTarget(row.Project || row.project, row.Activity || row.activity);
                
                html += `<tr>
                    <td class="project-cell">${row.Project || row.project || ''}</td>
                    <td class="activity-cell">${row.Activity || row.activity || ''}</td>
                    <td class="number kashmir-col">${kA.toLocaleString()}</td>
                    <td class="number jammu-col">${jA.toLocaleString()}</td>
                    <td class="number" style="color:#e65100;background:#fff3e0;font-weight:600">${tA.toLocaleString()}</td>
                    <td class="number kashmir-col">${kAp.toLocaleString()}</td>
                    <td class="number jammu-col">${jAp.toLocaleString()}</td>
                    <td class="number total-col">${tAp.toLocaleString()}</td>
                    <td class="number" style="color:#6a1b9a;background:#f3e5f5;font-weight:600">${tgt}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Auto-refresh every 5 minutes
        setInterval(() => {
            if (sheetConfig.sheetId && sheetConfig.apiKey) {
                loadData();
            }
        }, 300000); // 5 minutes
    </script>
</body>
</html>
